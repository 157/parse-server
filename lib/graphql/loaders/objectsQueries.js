"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = exports.findObjects = exports.getObject = void 0;

var _graphql = require("graphql");

var _graphqlListFields = _interopRequireDefault(require("graphql-list-fields"));

var _node = _interopRequireDefault(require("parse/node"));

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var _rest = _interopRequireDefault(require("../../rest"));

var _query = require("../transformers/query");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const getObject = async (className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info) => {
  const options = {};

  if (keys) {
    options.keys = keys;
  }

  if (include) {
    options.include = include;

    if (includeReadPreference) {
      options.includeReadPreference = includeReadPreference;
    }
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  const response = await _rest.default.get(config, auth, className, objectId, options, info.clientSDK);

  if (!response.results || response.results.length == 0) {
    throw new _node.default.Error(_node.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
  }

  if (className === '_User') {
    delete response.results[0].sessionToken;
  }

  return response.results[0];
};

exports.getObject = getObject;

const findObjects = async (className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields) => {
  if (!where) {
    where = {};
  }

  (0, _query.transformQueryInputToParse)(where);
  const options = {};

  if (selectedFields.includes('results')) {
    if (limit || limit === 0) {
      options.limit = limit;
    }

    if (options.limit !== 0) {
      if (order) {
        options.order = order;
      }

      if (skip) {
        options.skip = skip;
      }

      if (config.maxLimit && options.limit > config.maxLimit) {
        // Silently replace the limit on the query with the max configured
        options.limit = config.maxLimit;
      }

      if (keys) {
        options.keys = keys;
      }

      if (includeAll === true) {
        options.includeAll = includeAll;
      }

      if (!options.includeAll && include) {
        options.include = include;
      }

      if ((options.includeAll || options.include) && includeReadPreference) {
        options.includeReadPreference = includeReadPreference;
      }
    }
  } else {
    options.limit = 0;
  }

  if (selectedFields.includes('count')) {
    options.count = true;
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  if (Object.keys(where).length > 0 && subqueryReadPreference) {
    options.subqueryReadPreference = subqueryReadPreference;
  }

  return await _rest.default.find(config, auth, className, where, options, info.clientSDK);
};

exports.findObjects = findObjects;

const load = parseGraphQLSchema => {
  parseGraphQLSchema.addGraphQLQuery('get', {
    description: 'The get query can be used to get an object of a certain class by its objectId.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      objectId: defaultGraphQLTypes.OBJECT_ID_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.OBJECT),

    async resolve(_source, args, context) {
      try {
        const {
          className,
          objectId,
          keys,
          include,
          readPreference,
          includeReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        return await getObject(className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  }, true, true);
  parseGraphQLSchema.addGraphQLQuery('find', {
    description: 'The find query can be used to find objects of a certain class.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      where: defaultGraphQLTypes.WHERE_ATT,
      order: {
        description: 'This is the order in which the objects should be returned',
        type: _graphql.GraphQLString
      },
      skip: defaultGraphQLTypes.SKIP_ATT,
      limit: defaultGraphQLTypes.LIMIT_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      includeAll: {
        description: 'All pointers will be returned',
        type: _graphql.GraphQLBoolean
      },
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT,
      subqueryReadPreference: defaultGraphQLTypes.SUBQUERY_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.FIND_RESULT),

    async resolve(_source, args, context, queryInfo) {
      try {
        const {
          className,
          where,
          order,
          skip,
          limit,
          keys,
          include,
          includeAll,
          readPreference,
          includeReadPreference,
          subqueryReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        const selectedFields = (0, _graphqlListFields.default)(queryInfo);
        return await findObjects(className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  }, true, true);
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvb2JqZWN0c1F1ZXJpZXMuanMiXSwibmFtZXMiOlsiZ2V0T2JqZWN0IiwiY2xhc3NOYW1lIiwib2JqZWN0SWQiLCJrZXlzIiwiaW5jbHVkZSIsInJlYWRQcmVmZXJlbmNlIiwiaW5jbHVkZVJlYWRQcmVmZXJlbmNlIiwiY29uZmlnIiwiYXV0aCIsImluZm8iLCJvcHRpb25zIiwicmVzcG9uc2UiLCJyZXN0IiwiZ2V0IiwiY2xpZW50U0RLIiwicmVzdWx0cyIsImxlbmd0aCIsIlBhcnNlIiwiRXJyb3IiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwic2Vzc2lvblRva2VuIiwiZmluZE9iamVjdHMiLCJ3aGVyZSIsIm9yZGVyIiwic2tpcCIsImxpbWl0IiwiaW5jbHVkZUFsbCIsInN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UiLCJzZWxlY3RlZEZpZWxkcyIsImluY2x1ZGVzIiwibWF4TGltaXQiLCJjb3VudCIsIk9iamVjdCIsImZpbmQiLCJsb2FkIiwicGFyc2VHcmFwaFFMU2NoZW1hIiwiYWRkR3JhcGhRTFF1ZXJ5IiwiZGVzY3JpcHRpb24iLCJhcmdzIiwiZGVmYXVsdEdyYXBoUUxUeXBlcyIsIkNMQVNTX05BTUVfQVRUIiwiT0JKRUNUX0lEX0FUVCIsIktFWVNfQVRUIiwiSU5DTFVERV9BVFQiLCJSRUFEX1BSRUZFUkVOQ0VfQVRUIiwiSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwidHlwZSIsIkdyYXBoUUxOb25OdWxsIiwiT0JKRUNUIiwicmVzb2x2ZSIsIl9zb3VyY2UiLCJjb250ZXh0IiwiZSIsImhhbmRsZUVycm9yIiwiV0hFUkVfQVRUIiwiR3JhcGhRTFN0cmluZyIsIlNLSVBfQVRUIiwiTElNSVRfQVRUIiwiR3JhcGhRTEJvb2xlYW4iLCJTVUJRVUVSWV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwiRklORF9SRVNVTFQiLCJxdWVyeUluZm8iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFD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QURJO0FBRUpxQixVQUFBQSxLQUZJO0FBR0pDLFVBQUFBLEtBSEk7QUFJSkMsVUFBQUEsSUFKSTtBQUtKQyxVQUFBQSxLQUxJO0FBTUp0QixVQUFBQSxJQU5JO0FBT0pDLFVBQUFBLE9BUEk7QUFRSnNCLFVBQUFBLFVBUkk7QUFTSnJCLFVBQUFBLGNBVEk7QUFVSkMsVUFBQUEscUJBVkk7QUFXSnFCLFVBQUFBO0FBWEksWUFZRlcsSUFaSjtBQWNBLGNBQU07QUFBRS9CLFVBQUFBLE1BQUY7QUFBVUMsVUFBQUEsSUFBVjtBQUFnQkMsVUFBQUE7QUFBaEIsWUFBeUIwQyxPQUEvQjtBQUNBLGNBQU12QixjQUFjLEdBQUcsZ0NBQWNpQyxTQUFkLENBQXZCO0FBRUEsZUFBTyxNQUFNeEMsV0FBVyxDQUN0QnBCLFNBRHNCLEVBRXRCcUIsS0FGc0IsRUFHdEJDLEtBSHNCLEVBSXRCQyxJQUpzQixFQUt0QkMsS0FMc0IsRUFNdEJ0QixJQU5zQixFQU90QkMsT0FQc0IsRUFRdEJzQixVQVJzQixFQVN0QnJCLGNBVHNCLEVBVXRCQyxxQkFWc0IsRUFXdEJxQixzQkFYc0IsRUFZdEJwQixNQVpzQixFQWF0QkMsSUFic0IsRUFjdEJDLElBZHNCLEVBZXRCbUIsY0Fmc0IsQ0FBeEI7QUFpQkQsT0FuQ0QsQ0FtQ0UsT0FBT3dCLENBQVAsRUFBVTtBQUNWakIsUUFBQUEsa0JBQWtCLENBQUNrQixXQUFuQixDQUErQkQsQ0FBL0I7QUFDRDtBQUNGOztBQWhFSCxHQUZGLEVBb0VFLElBcEVGLEVBcUVFLElBckVGO0FBdUVELENBdkhEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JhcGhRTE5vbk51bGwsIEdyYXBoUUxCb29sZWFuLCBHcmFwaFFMU3RyaW5nIH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgZ2V0RmllbGROYW1lcyBmcm9tICdncmFwaHFsLWxpc3QtZmllbGRzJztcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcbmltcG9ydCAqIGFzIGRlZmF1bHRHcmFwaFFMVHlwZXMgZnJvbSAnLi9kZWZhdWx0R3JhcGhRTFR5cGVzJztcbmltcG9ydCByZXN0IGZyb20gJy4uLy4uL3Jlc3QnO1xuaW1wb3J0IHsgdHJhbnNmb3JtUXVlcnlJbnB1dFRvUGFyc2UgfSBmcm9tICcuLi90cmFuc2Zvcm1lcnMvcXVlcnknO1xuXG5jb25zdCBnZXRPYmplY3QgPSBhc3luYyAoXG4gIGNsYXNzTmFtZSxcbiAgb2JqZWN0SWQsXG4gIGtleXMsXG4gIGluY2x1ZGUsXG4gIHJlYWRQcmVmZXJlbmNlLFxuICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gIGNvbmZpZyxcbiAgYXV0aCxcbiAgaW5mb1xuKSA9PiB7XG4gIGNvbnN0IG9wdGlvbnMgPSB7fTtcbiAgaWYgKGtleXMpIHtcbiAgICBvcHRpb25zLmtleXMgPSBrZXlzO1xuICB9XG4gIGlmIChpbmNsdWRlKSB7XG4gICAgb3B0aW9ucy5pbmNsdWRlID0gaW5jbHVkZTtcbiAgICBpZiAoaW5jbHVkZVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgICBvcHRpb25zLmluY2x1ZGVSZWFkUHJlZmVyZW5jZSA9IGluY2x1ZGVSZWFkUHJlZmVyZW5jZTtcbiAgICB9XG4gIH1cbiAgaWYgKHJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5yZWFkUHJlZmVyZW5jZSA9IHJlYWRQcmVmZXJlbmNlO1xuICB9XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXN0LmdldChcbiAgICBjb25maWcsXG4gICAgYXV0aCxcbiAgICBjbGFzc05hbWUsXG4gICAgb2JqZWN0SWQsXG4gICAgb3B0aW9ucyxcbiAgICBpbmZvLmNsaWVudFNES1xuICApO1xuXG4gIGlmICghcmVzcG9uc2UucmVzdWx0cyB8fCByZXNwb25zZS5yZXN1bHRzLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kLicpO1xuICB9XG5cbiAgaWYgKGNsYXNzTmFtZSA9PT0gJ19Vc2VyJykge1xuICAgIGRlbGV0ZSByZXNwb25zZS5yZXN1bHRzWzBdLnNlc3Npb25Ub2tlbjtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZS5yZXN1bHRzWzBdO1xufTtcblxuY29uc3QgZmluZE9iamVjdHMgPSBhc3luYyAoXG4gIGNsYXNzTmFtZSxcbiAgd2hlcmUsXG4gIG9yZGVyLFxuICBza2lwLFxuICBsaW1pdCxcbiAga2V5cyxcbiAgaW5jbHVkZSxcbiAgaW5jbHVkZUFsbCxcbiAgcmVhZFByZWZlcmVuY2UsXG4gIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgc3VicXVlcnlSZWFkUHJlZmVyZW5jZSxcbiAgY29uZmlnLFxuICBhdXRoLFxuICBpbmZvLFxuICBzZWxlY3RlZEZpZWxkc1xuKSA9PiB7XG4gIGlmICghd2hlcmUpIHtcbiAgICB3aGVyZSA9IHt9O1xuICB9XG5cbiAgdHJhbnNmb3JtUXVlcnlJbnB1dFRvUGFyc2Uod2hlcmUpO1xuXG4gIGNvbnN0IG9wdGlvbnMgPSB7fTtcblxuICBpZiAoc2VsZWN0ZWRGaWVsZHMuaW5jbHVkZXMoJ3Jlc3VsdHMnKSkge1xuICAgIGlmIChsaW1pdCB8fCBsaW1pdCA9PT0gMCkge1xuICAgICAgb3B0aW9ucy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5saW1pdCAhPT0gMCkge1xuICAgICAgaWYgKG9yZGVyKSB7XG4gICAgICAgIG9wdGlvbnMub3JkZXIgPSBvcmRlcjtcbiAgICAgIH1cbiAgICAgIGlmIChza2lwKSB7XG4gICAgICAgIG9wdGlvbnMuc2tpcCA9IHNraXA7XG4gICAgICB9XG4gICAgICBpZiAoY29uZmlnLm1heExpbWl0ICYmIG9wdGlvbnMubGltaXQgPiBjb25maWcubWF4TGltaXQpIHtcbiAgICAgICAgLy8gU2lsZW50bHkgcmVwbGFjZSB0aGUgbGltaXQgb24gdGhlIHF1ZXJ5IHdpdGggdGhlIG1heCBjb25maWd1cmVkXG4gICAgICAgIG9wdGlvbnMubGltaXQgPSBjb25maWcubWF4TGltaXQ7XG4gICAgICB9XG4gICAgICBpZiAoa2V5cykge1xuICAgICAgICBvcHRpb25zLmtleXMgPSBrZXlzO1xuICAgICAgfVxuICAgICAgaWYgKGluY2x1ZGVBbGwgPT09IHRydWUpIHtcbiAgICAgICAgb3B0aW9ucy5pbmNsdWRlQWxsID0gaW5jbHVkZUFsbDtcbiAgICAgIH1cbiAgICAgIGlmICghb3B0aW9ucy5pbmNsdWRlQWxsICYmIGluY2x1ZGUpIHtcbiAgICAgICAgb3B0aW9ucy5pbmNsdWRlID0gaW5jbHVkZTtcbiAgICAgIH1cbiAgICAgIGlmICgob3B0aW9ucy5pbmNsdWRlQWxsIHx8IG9wdGlvbnMuaW5jbHVkZSkgJiYgaW5jbHVkZVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgICAgIG9wdGlvbnMuaW5jbHVkZVJlYWRQcmVmZXJlbmNlID0gaW5jbHVkZVJlYWRQcmVmZXJlbmNlO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBvcHRpb25zLmxpbWl0ID0gMDtcbiAgfVxuXG4gIGlmIChzZWxlY3RlZEZpZWxkcy5pbmNsdWRlcygnY291bnQnKSkge1xuICAgIG9wdGlvbnMuY291bnQgPSB0cnVlO1xuICB9XG5cbiAgaWYgKHJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5yZWFkUHJlZmVyZW5jZSA9IHJlYWRQcmVmZXJlbmNlO1xuICB9XG4gIGlmIChPYmplY3Qua2V5cyh3aGVyZSkubGVuZ3RoID4gMCAmJiBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5zdWJxdWVyeVJlYWRQcmVmZXJlbmNlID0gc3VicXVlcnlSZWFkUHJlZmVyZW5jZTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCByZXN0LmZpbmQoXG4gICAgY29uZmlnLFxuICAgIGF1dGgsXG4gICAgY2xhc3NOYW1lLFxuICAgIHdoZXJlLFxuICAgIG9wdGlvbnMsXG4gICAgaW5mby5jbGllbnRTREtcbiAgKTtcbn07XG5cbmNvbnN0IGxvYWQgPSBwYXJzZUdyYXBoUUxTY2hlbWEgPT4ge1xuICBwYXJzZUdyYXBoUUxTY2hlbWEuYWRkR3JhcGhRTFF1ZXJ5KFxuICAgICdnZXQnLFxuICAgIHtcbiAgICAgIGRlc2NyaXB0aW9uOlxuICAgICAgICAnVGhlIGdldCBxdWVyeSBjYW4gYmUgdXNlZCB0byBnZXQgYW4gb2JqZWN0IG9mIGEgY2VydGFpbiBjbGFzcyBieSBpdHMgb2JqZWN0SWQuJyxcbiAgICAgIGFyZ3M6IHtcbiAgICAgICAgY2xhc3NOYW1lOiBkZWZhdWx0R3JhcGhRTFR5cGVzLkNMQVNTX05BTUVfQVRULFxuICAgICAgICBvYmplY3RJZDogZGVmYXVsdEdyYXBoUUxUeXBlcy5PQkpFQ1RfSURfQVRULFxuICAgICAgICBrZXlzOiBkZWZhdWx0R3JhcGhRTFR5cGVzLktFWVNfQVRULFxuICAgICAgICBpbmNsdWRlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLklOQ0xVREVfQVRULFxuICAgICAgICByZWFkUHJlZmVyZW5jZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2U6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgfSxcbiAgICAgIHR5cGU6IG5ldyBHcmFwaFFMTm9uTnVsbChkZWZhdWx0R3JhcGhRTFR5cGVzLk9CSkVDVCksXG4gICAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICBvYmplY3RJZCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgfSA9IGFyZ3M7XG5cbiAgICAgICAgICBjb25zdCB7IGNvbmZpZywgYXV0aCwgaW5mbyB9ID0gY29udGV4dDtcblxuICAgICAgICAgIHJldHVybiBhd2FpdCBnZXRPYmplY3QoXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICBvYmplY3RJZCxcbiAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICBhdXRoLFxuICAgICAgICAgICAgaW5mb1xuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSxcbiAgICB0cnVlLFxuICAgIHRydWVcbiAgKTtcblxuICBwYXJzZUdyYXBoUUxTY2hlbWEuYWRkR3JhcGhRTFF1ZXJ5KFxuICAgICdmaW5kJyxcbiAgICB7XG4gICAgICBkZXNjcmlwdGlvbjpcbiAgICAgICAgJ1RoZSBmaW5kIHF1ZXJ5IGNhbiBiZSB1c2VkIHRvIGZpbmQgb2JqZWN0cyBvZiBhIGNlcnRhaW4gY2xhc3MuJyxcbiAgICAgIGFyZ3M6IHtcbiAgICAgICAgY2xhc3NOYW1lOiBkZWZhdWx0R3JhcGhRTFR5cGVzLkNMQVNTX05BTUVfQVRULFxuICAgICAgICB3aGVyZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5XSEVSRV9BVFQsXG4gICAgICAgIG9yZGVyOiB7XG4gICAgICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgICAgICAnVGhpcyBpcyB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIG9iamVjdHMgc2hvdWxkIGJlIHJldHVybmVkJyxcbiAgICAgICAgICB0eXBlOiBHcmFwaFFMU3RyaW5nLFxuICAgICAgICB9LFxuICAgICAgICBza2lwOiBkZWZhdWx0R3JhcGhRTFR5cGVzLlNLSVBfQVRULFxuICAgICAgICBsaW1pdDogZGVmYXVsdEdyYXBoUUxUeXBlcy5MSU1JVF9BVFQsXG4gICAgICAgIGtleXM6IGRlZmF1bHRHcmFwaFFMVHlwZXMuS0VZU19BVFQsXG4gICAgICAgIGluY2x1ZGU6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9BVFQsXG4gICAgICAgIGluY2x1ZGVBbGw6IHtcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0FsbCBwb2ludGVycyB3aWxsIGJlIHJldHVybmVkJyxcbiAgICAgICAgICB0eXBlOiBHcmFwaFFMQm9vbGVhbixcbiAgICAgICAgfSxcbiAgICAgICAgcmVhZFByZWZlcmVuY2U6IGRlZmF1bHRHcmFwaFFMVHlwZXMuUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLklOQ0xVREVfUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICAgICAgc3VicXVlcnlSZWFkUHJlZmVyZW5jZTpcbiAgICAgICAgICBkZWZhdWx0R3JhcGhRTFR5cGVzLlNVQlFVRVJZX1JFQURfUFJFRkVSRU5DRV9BVFQsXG4gICAgICB9LFxuICAgICAgdHlwZTogbmV3IEdyYXBoUUxOb25OdWxsKGRlZmF1bHRHcmFwaFFMVHlwZXMuRklORF9SRVNVTFQpLFxuICAgICAgYXN5bmMgcmVzb2x2ZShfc291cmNlLCBhcmdzLCBjb250ZXh0LCBxdWVyeUluZm8pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICAgIG9yZGVyLFxuICAgICAgICAgICAgc2tpcCxcbiAgICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgICBpbmNsdWRlQWxsLFxuICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIH0gPSBhcmdzO1xuXG4gICAgICAgICAgY29uc3QgeyBjb25maWcsIGF1dGgsIGluZm8gfSA9IGNvbnRleHQ7XG4gICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSBnZXRGaWVsZE5hbWVzKHF1ZXJ5SW5mbyk7XG5cbiAgICAgICAgICByZXR1cm4gYXdhaXQgZmluZE9iamVjdHMoXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICAgIG9yZGVyLFxuICAgICAgICAgICAgc2tpcCxcbiAgICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgICBpbmNsdWRlQWxsLFxuICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgYXV0aCxcbiAgICAgICAgICAgIGluZm8sXG4gICAgICAgICAgICBzZWxlY3RlZEZpZWxkc1xuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSxcbiAgICB0cnVlLFxuICAgIHRydWVcbiAgKTtcbn07XG5cbmV4cG9ydCB7IGdldE9iamVjdCwgZmluZE9iamVjdHMsIGxvYWQgfTtcbiJdfQ==